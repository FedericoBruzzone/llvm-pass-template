# LLVM Pass Template

This repository provides a template to create your own LLVM passes using LLVM 21, drawing heavily on [llvm-tutor](https://github.com/banach-space/llvm-tutor) and [Writing an LLVM Pass](https://llvm.org/docs/WritingAnLLVMNewPMPass.html).

It allows you to quickly bootstrap new _out-of-tree_ LLVM passes with minimal effort â€” that is, without the need to build LLVM from sources.

You can `git clone` this repository and start implementing your own LLVM passes right away. The `lib` folder contains an example pass called **FunctionCounter**, which counts the number of functions in the input LLVM IR file and prints the result to the standard output. 

## Building and Running

The [GUIDELINES.md](GUIDELINES.md) file includes detailed instructions on how to set up your system to have all the required dependencies, including LLVM 21 installation.

To easily emit _human-readable_ LLVM IR files (`.ll`) from C/C++ source files, you can use `clang`:

```bash
${LLVM_DIR}/bin/clang -fno-discard-value-names -S -emit-llvm <file>.c -o <file>.ll
```

To build the pass, run the following commands from the root of the repository:

```bash
export LLVM_DIR=<see GUIDELINES.md to know the location of your LLVM 21 installation>
mkdir build
cd build
cmake -DLT_LLVM_INSTALL_DIR=${LLVM_DIR} .. # -G Ninja
make # ninja
```

> Note that, the `build` folder is hardcoded within `.clangd` file to provide better IDE support. `clangd` uses the `compile_commands.json` file generated by CMake to provide accurate code completion and navigation features. If you decide to use a different build folder, make sure to update the path in `.clangd` accordingly.

To run the pass on an LLVM IR file, use the `opt` tool as follows:

```bash
${LLVM_DIR}/bin/opt \
    --load-pass-plugin build/lib/libFunctionCounter.{dylib|so} \
    --passes="print<function-counter>" \
    -disable-output \
    <file>.ll
```

> Note that, `-disable-output` is used to avoid generating an output file. If you want to generate an output file, replace `-disable-output` with `-S -o <output-file>.ll`. Assuming you have an LLVM assert build,  if your pass leverages the LLVM internal logger, you can either enable logging globally with `-debug` or selectively for your pass only. To enable logging for your pass only, after the definition of the `DEBUG_TYPE=<what-you-want>` macro, you can enable logging by passing the `-debug-only="<what-you-want>"` flag to `opt`.

## Run the pass as executable

You can run the analysis pass through a standalone tool called `func-count`.
`func-count` is an LLVM based executable defined in
[FuncCountMain.cpp](https://github.com/FedericoBruzzone/llvm-pass-template/blob/main/bin/FuncCountMain.cpp).
It is a command line wrapper that allows you to run **FunctionCounter** without the need for **opt**:

```bash
<build_dir>/bin/func-count <file>.ll
```

It is an example of a relatively basic static analysis tool. Its implementation demonstrates how basic pass management in LLVM works (i.e. it handles that for itself instead of relying on **opt**).

## Testing

In order to run the tests, you need to install `llvm-lit` (i.e., `lit`).
If you have LLVM built from sources, `llvm-lit` is located in the `<llvm-build-dir>/bin/` folder.
On the other hand, it is not bundled with LLVM 21 packages, but you can install it with `pip` or `brew` (on macOS).

```bash
{pip | brew} install lit
```

To run the tests, execute the following command from the root of the repository:

```bash
lit ./build/test
```
